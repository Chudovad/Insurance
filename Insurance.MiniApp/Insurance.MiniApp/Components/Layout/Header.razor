@using Insurance.MiniApp.Services
@using Microsoft.AspNetCore.Components
@implements IDisposable
@inject ITokenService TokenService
@inject IAuthService AuthService
@inject NavigationManager Navigation

@rendermode InteractiveServer

<MudAppBar Elevation="1" Class="d-none d-md-flex">
    <MudContainer MaxWidth="MaxWidth.Large" Class="d-flex align-center px-0">
        <MudIcon Icon="@Icons.Material.Filled.VerifiedUser" Size="Size.Large" Style="color:#246bce;" />
        <MudLink Href="/" Underline="Underline.None" Class="ml-2">
            <MudText Typo="Typo.h6" Style="font-weight:600; color:#222222;">
                INSURANCE
            </MudText>
        </MudLink>
        <MudSpacer />
        @if (_isAuthenticated)
        {
            <MudText Typo="Typo.body1" Class="mr-4" Style="color:#222222;">
                @_userEmail
            </MudText>
            <MudButton Href="/" Color="Color.Primary" Variant="Variant.Filled" Class="mr-2" StartIcon="@Icons.Material.Filled.Home">
                Главная
            </MudButton>
            <MudButton Href="/profile" Color="Color.Primary" Variant="Variant.Filled" Class="mr-2" StartIcon="@Icons.Material.Filled.AccountCircle">
                Профиль
            </MudButton>
            <MudButton OnClick="HandleLogout" Color="Color.Primary" Variant="Variant.Filled" StartIcon="@Icons.Material.Filled.Logout">
                Выйти
            </MudButton>
        }
        else
        {
            <MudButton Href="/login" Color="Color.Primary" Variant="Variant.Filled" StartIcon="@Icons.Material.Filled.Login">
                Войти
            </MudButton>
        }
    </MudContainer>
</MudAppBar>

<MudAppBar Bottom Fixed Elevation="3" Color="Color.Surface" Class="pt-2 rounded-pill border-solid border mud-border-inherit mobile-bottom-nav d-flex d-md-none">
    <MudStack Row Justify="Justify.SpaceAround" AlignItems="AlignItems.Center" Style="width: 100%;">
        @if (_isAuthenticated)
        {
            <MudStack Spacing="0" AlignItems="AlignItems.Center" Style="cursor: pointer;" @onclick="@(() => Navigation.NavigateTo("/"))">
                <MudIcon Icon="@Icons.Material.Filled.Home"
                         Color="@(GetNavItemColor("/", true))"
                         Size="Size.Medium" />
                <MudText Typo="Typo.caption" Color="@(GetNavItemColor("/", true))" Style="font-size: 0.7rem; margin-top: 2px;">
                    Главная
                </MudText>
            </MudStack>

            <MudStack Spacing="0" AlignItems="AlignItems.Center" Style="cursor: pointer;" @onclick="@(() => Navigation.NavigateTo("/profile"))">
                <MudIcon Icon="@Icons.Material.Filled.Person"
                         Color="@(GetNavItemColor("/profile", false))"
                         Size="Size.Medium" />
                <MudText Typo="Typo.caption" Color="@(GetNavItemColor("/profile", false))" Style="font-size: 0.7rem; margin-top: 2px;">
                    Профиль
                </MudText>
            </MudStack>

            <MudStack Spacing="0" AlignItems="AlignItems.Center" Style="cursor: pointer;" @onclick="HandleLogout">
                <MudIcon Icon="@Icons.Material.Filled.Logout"
                         Size="Size.Medium" />
                <MudText Typo="Typo.caption" Style="font-size: 0.7rem; margin-top: 2px;">
                    Выйти
                </MudText>
            </MudStack>
        }
        else
        {
            <MudStack Spacing="0" AlignItems="AlignItems.Center" Style="cursor: pointer;" @onclick="@(() => Navigation.NavigateTo("/login"))">
                <MudIcon Icon="@Icons.Material.Filled.Login"
                         Color="@(GetNavItemColor("/login", false))"
                         Size="Size.Medium" />
                <MudText Typo="Typo.caption" Color="@(GetNavItemColor("/login", false))" Style="font-size: 0.7rem; margin-top: 2px;">
                    Войти
                </MudText>
            </MudStack>
        }
    </MudStack>
</MudAppBar>

@code {

    private bool _isAuthenticated = false;
    private string? _userEmail;

    protected override async Task OnInitializedAsync()
    {
        await LoadAuthState();

        Navigation.LocationChanged += OnLocationChanged;
        TokenService.AuthStateChanged += OnAuthStateChanged;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await LoadAuthState();
            StateHasChanged();
        }
    }

    /// <summary>
    /// Обновляет состояние авторизации при навигации.
    /// </summary>
    private async void OnLocationChanged(object? sender, LocationChangedEventArgs e)
    {
        await InvokeAsync(async () =>
        {
            await LoadAuthState();
            StateHasChanged();
        });
    }

    /// <summary>
    /// Обновляет состояние при изменении токенов (логин, логаут, refresh).
    /// </summary>
    private async void OnAuthStateChanged()
    {
        await InvokeAsync(async () =>
        {
            await LoadAuthState();
            StateHasChanged();
        });
    }

    /// <summary>
    /// Загружает текущее состояние авторизации.
    /// </summary>
    private async Task LoadAuthState()
    {
        _isAuthenticated = await TokenService.IsAuthenticatedAsync();
        _userEmail = _isAuthenticated ? await TokenService.GetUserEmailAsync() : null;
    }

    private async Task HandleLogout()
    {
        _isAuthenticated = false;
        _userEmail = null;

        await TokenService.ClearTokensAsync();
        Navigation.NavigateTo("/login");
    }

    private Color GetNavItemColor(string route, bool exactMatch)
    {
        var currentUri = Navigation.ToBaseRelativePath(Navigation.Uri);
        var routePath = route.TrimStart('/');

        bool isActive;
        if (exactMatch)
        {
            isActive = currentUri == routePath || (string.IsNullOrEmpty(routePath) && string.IsNullOrEmpty(currentUri));
        }
        else
        {
            isActive = !string.IsNullOrEmpty(routePath) && currentUri.StartsWith(routePath, StringComparison.OrdinalIgnoreCase);
        }

        return isActive ? Color.Primary : Color.Default;
    }

    public void Dispose()
    {
        Navigation.LocationChanged -= OnLocationChanged;
        TokenService.AuthStateChanged -= OnAuthStateChanged;
    }
}
